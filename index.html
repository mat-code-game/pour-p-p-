<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pac-Man Mobile</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }
    
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      font-family: 'Courier New', monospace;
      background: radial-gradient(circle at top, #020617, #0f172a);
      color: #e5e7eb;
      overflow-x: hidden;
      overflow-y: auto;
      padding: 5px;
    }

    h1 {
      margin: 10px 0;
      font-size: 24px;
      color: #facc15;
      letter-spacing: 2px;
      text-shadow: 0 0 20px #facc15;
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from { text-shadow: 0 0 20px #facc15; }
      to { text-shadow: 0 0 30px #facc15, 0 0 40px #facc15; }
    }

    #stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }

    .stat {
      padding: 6px 10px;
      background: rgba(29, 78, 216, 0.3);
      border-radius: 6px;
      border: 2px solid #1d4ed8;
      text-align: center;
    }

    .stat-label {
      color: #94a3b8;
      font-size: 10px;
      display: block;
    }

    .stat-value {
      color: #facc15;
      font-size: 16px;
      font-weight: bold;
    }

    .lives-container {
      display: flex;
      gap: 4px;
      justify-content: center;
      align-items: center;
    }

    .life-icon {
      width: 16px;
      height: 16px;
      background: #facc15;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 0 8px #facc15;
    }

    #game-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #game {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(250, 204, 21, 0.3);
      border: 3px solid #1d4ed8;
      max-width: 100%;
    }

    canvas {
      background: #020617;
      display: block;
      width: 100%;
      max-width: 448px;
      height: auto;
    }

    #pause-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: #facc15;
      font-weight: bold;
      text-shadow: 0 0 20px #facc15;
      z-index: 10;
    }

    #pause-overlay.active {
      display: flex;
    }

    #message {
      margin: 5px 0;
      font-size: 12px;
      min-height: 18px;
      color: #facc15;
      font-weight: bold;
      text-align: center;
      order: 4;
      width: 100%;
    }

    #game-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      justify-content: center;
      width: 100%;
      max-width: 1000px;
      margin-top: 10px;
      flex: 1;
    }

    #powers-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 180px;
    }

    #controls-mobile {
      padding: 15px;
      background: rgba(29, 78, 216, 0.2);
      border-radius: 8px;
      border: 2px solid #1d4ed8;
      min-width: 220px;
    }

    #joystick-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 0 auto 15px;
    }

    #joystick-base {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(29, 78, 216, 0.3), rgba(29, 78, 216, 0.6));
      border: 4px solid #3b82f6;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
    }

    #joystick-stick {
      position: absolute;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, #facc15, #f59e0b);
      border: 4px solid #fbbf24;
      box-shadow: 0 4px 15px rgba(250, 204, 21, 0.6);
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      touch-action: none;
      transition: box-shadow 0.1s;
    }

    #joystick-stick:active {
      box-shadow: 0 2px 8px rgba(250, 204, 21, 0.8);
    }

    #joystick-stick::before {
      content: 'üéÆ';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
    }

    .joystick-direction {
      position: absolute;
      font-size: 20px;
      color: #94a3b8;
      opacity: 0.5;
    }

    .joystick-up {
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .joystick-down {
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .joystick-left {
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    .joystick-right {
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    #dpad {
      display: none;
    }

    .dpad-btn {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      border: 3px solid #3b82f6;
      border-radius: 12px;
      color: #facc15;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
      touch-action: manipulation;
    }

    .dpad-btn:active {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(29, 78, 216, 0.6);
    }

    .dpad-btn.center {
      background: linear-gradient(135deg, #f59e0b, #facc15);
      border-color: #fbbf24;
    }

    .dpad-btn.center:active {
      background: linear-gradient(135deg, #fbbf24, #fde047);
    }

    #up-btn { grid-column: 2; grid-row: 1; }
    #left-btn { grid-column: 1; grid-row: 2; }
    #pause-btn { grid-column: 2; grid-row: 2; font-size: 20px; }
    #right-btn { grid-column: 3; grid-row: 2; }
    #down-btn { grid-column: 2; grid-row: 3; }

    .action-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .action-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      border: 2px solid #3b82f6;
      border-radius: 8px;
      color: #facc15;
      font-size: 14px;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 15px rgba(29, 78, 216, 0.4);
      touch-action: manipulation;
    }

    .action-btn:active {
      background: linear-gradient(135deg, #2563eb, #3b82f6);
      transform: translateY(2px);
    }

    #fullscreen-btn {
      width: 100%;
      margin-top: 10px;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      border-color: #4ade80;
    }

    #fullscreen-btn:active {
      background: linear-gradient(135deg, #22c55e, #4ade80);
    }

    /* Menu de personnalisation */
    #customization-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      overflow-y: auto;
    }

    #customization-menu.active {
      display: flex;
    }

    .menu-content {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border: 3px solid #3b82f6;
      box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .menu-title {
      font-size: 24px;
      color: #facc15;
      text-shadow: 0 0 10px #facc15;
    }

    .close-btn {
      background: #ef4444;
      border: none;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: #dc2626;
      transform: scale(1.1);
    }

    .menu-section {
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 18px;
      color: #3b82f6;
      margin-bottom: 15px;
      border-bottom: 2px solid #1d4ed8;
      padding-bottom: 8px;
    }

    /* Skins */
    .skins-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 10px;
    }

    .skin-item {
      background: rgba(29, 78, 216, 0.2);
      border: 3px solid #1d4ed8;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .skin-item:hover {
      transform: scale(1.05);
      border-color: #3b82f6;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
    }

    .skin-item.active {
      border-color: #facc15;
      background: rgba(250, 204, 21, 0.2);
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.6);
    }

    .skin-item.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .skin-icon {
      font-size: 36px;
      margin-bottom: 5px;
    }

    .skin-name {
      font-size: 11px;
      color: #94a3b8;
    }

    .skin-item.active .skin-name {
      color: #facc15;
      font-weight: bold;
    }

    .lock-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 14px;
    }

    /* Th√®mes */
    .themes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
    }

    .theme-item {
      background: rgba(29, 78, 216, 0.2);
      border: 3px solid #1d4ed8;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-item:hover {
      transform: scale(1.05);
      border-color: #3b82f6;
    }

    .theme-item.active {
      border-color: #facc15;
      background: rgba(250, 204, 21, 0.2);
      box-shadow: 0 0 20px rgba(250, 204, 21, 0.6);
    }

    .theme-preview {
      width: 100%;
      height: 60px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .theme-name {
      font-size: 13px;
      color: #e5e7eb;
      font-weight: bold;
    }

    /* Succ√®s */
    .achievements-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .achievement-item {
      background: rgba(29, 78, 216, 0.2);
      border: 2px solid #1d4ed8;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.2s;
    }

    .achievement-item.unlocked {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.2);
      box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
    }

    .achievement-icon {
      font-size: 36px;
      min-width: 50px;
      text-align: center;
    }

    .achievement-item.unlocked .achievement-icon {
      animation: bounce 0.5s;
    }

    @keyframes bounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .achievement-info {
      flex: 1;
    }

    .achievement-name {
      font-size: 15px;
      color: #facc15;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .achievement-desc {
      font-size: 12px;
      color: #94a3b8;
    }

    .achievement-progress {
      font-size: 11px;
      color: #64748b;
      margin-top: 5px;
    }

    /* Notification de succ√®s */
    .achievement-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: 3px solid #4ade80;
      border-radius: 12px;
      padding: 15px 20px;
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 2000;
      box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
      animation: slideIn 0.5s ease-out;
    }

    .achievement-notification.show {
      display: flex;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notif-icon {
      font-size: 32px;
    }

    .notif-text {
      color: white;
    }

    .notif-title {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 3px;
    }

    .notif-desc {
      font-size: 12px;
      opacity: 0.9;
    }

    /* Bouton de personnalisation */
    #customize-btn {
      background: linear-gradient(135deg, #a855f7, #9333ea);
      border-color: #c084fc;
    }

    #customize-btn:active {
      background: linear-gradient(135deg, #c084fc, #a855f7);
    }

    /* Bouton de partage */
    #share-btn {
      background: linear-gradient(135deg, #06b6d4, #0891b2);
      border-color: #22d3ee;
    }

    #share-btn:active {
      background: linear-gradient(135deg, #22d3ee, #06b6d4);
    }

    .stats-display {
      background: rgba(15, 23, 42, 0.6);
      border: 2px solid #1d4ed8;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }

    .stat-box {
      text-align: center;
      padding: 10px;
      background: rgba(29, 78, 216, 0.2);
      border-radius: 8px;
    }

    .stat-box-value {
      font-size: 20px;
      color: #facc15;
      font-weight: bold;
    }

    .stat-box-label {
      font-size: 11px;
      color: #94a3b8;
      margin-top: 3px;
    }

    .power-mini {
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(29, 78, 216, 0.5);
      border-radius: 6px;
      padding: 8px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .power-mini-icon {
      font-size: 18px;
    }

    .power-mini-text {
      flex: 1;
    }

    .power-mini-name {
      font-weight: bold;
      display: block;
      margin-bottom: 2px;
    }

    .power-mini-duration {
      color: #64748b;
      font-size: 9px;
    }

    .power-invincible { color: #facc15; }
    .power-speed { color: #22c55e; }
    .power-shield { color: #3b82f6; }
    .power-freeze { color: #a855f7; }

    .combo-popup {
      position: absolute;
      font-size: 20px;
      font-weight: bold;
      color: #22c55e;
      text-shadow: 0 0 10px #22c55e;
      pointer-events: none;
      animation: popupFloat 1s ease-out forwards;
      z-index: 5;
    }

    @keyframes popupFloat {
      0% {
        opacity: 1;
        transform: translateY(0) scale(0.5);
      }
      100% {
        opacity: 0;
        transform: translateY(-40px) scale(1.5);
      }
    }

    /* Responsive mobile */
    @media (max-width: 768px) {
      body {
        padding: 5px;
      }

      h1 {
        font-size: 18px;
        margin: 5px 0;
      }

      #stats {
        gap: 5px;
        margin-bottom: 5px;
      }

      .stat {
        padding: 4px 6px;
      }

      .stat-label {
        font-size: 9px;
      }

      .stat-value {
        font-size: 13px;
      }

      .life-icon {
        width: 12px;
        height: 12px;
      }

      #game-layout {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        width: 100%;
      }

      #powers-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        width: 100%;
        max-width: 100%;
        order: 3;
      }

      #fullscreen-btn {
        grid-column: 1 / -1;
        margin-top: 5px;
      }

      .power-mini {
        padding: 6px;
        font-size: 10px;
      }

      .power-mini-icon {
        font-size: 16px;
      }

      .power-mini-name {
        font-size: 10px;
      }

      .power-mini-duration {
        font-size: 8px;
      }

      #game-container {
        order: 1;
        width: 100%;
      }

      canvas {
        max-width: 100%;
      }

      #controls-mobile {
        width: 100%;
        max-width: 100%;
        padding: 10px;
        order: 2;
      }

      #joystick-container {
        width: 180px;
        height: 180px;
      }

      #joystick-base {
        width: 180px;
        height: 180px;
      }

      #joystick-stick {
        width: 70px;
        height: 70px;
      }

      #joystick-stick::before {
        font-size: 24px;
      }

      .joystick-direction {
        font-size: 18px;
      }

      .action-buttons {
        margin-top: 8px;
      }

      .action-btn {
        padding: 8px 16px;
        font-size: 13px;
      }

      #message {
        font-size: 12px;
        margin: 5px 0;
      }
    }

    /* Tr√®s petits √©crans */
    @media (max-width: 400px) {
      h1 {
        font-size: 16px;
      }

      #joystick-container {
        width: 160px;
        height: 160px;
      }

      #joystick-base {
        width: 160px;
        height: 160px;
      }

      #joystick-stick {
        width: 60px;
        height: 60px;
      }

      #joystick-stick::before {
        font-size: 22px;
      }

      .joystick-direction {
        font-size: 16px;
      }

      .stat-label {
        font-size: 8px;
      }

      .stat-value {
        font-size: 12px;
      }
    }

    /* Orientation paysage */
    @media screen and (orientation: landscape) and (max-height: 500px) {
      body {
        flex-direction: column;
        padding: 5px;
        overflow-y: auto;
      }

      h1 {
        font-size: 16px;
        margin: 5px 0;
      }

      #stats {
        grid-template-columns: repeat(4, 1fr);
        max-width: 100%;
        gap: 5px;
        margin-bottom: 5px;
      }

      .stat {
        padding: 4px 6px;
      }

      .stat-label {
        font-size: 8px;
      }

      .stat-value {
        font-size: 12px;
      }

      #game-layout {
        flex-direction: row;
        gap: 10px;
        width: 100%;
      }

      #powers-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 140px;
        max-width: 140px;
        order: 1;
      }

      #fullscreen-btn {
        width: 100%;
      }

      .power-mini {
        padding: 5px;
        font-size: 9px;
      }

      .power-mini-icon {
        font-size: 14px;
      }

      #game-container {
        order: 2;
        flex: 1;
      }

      #game {
        max-height: calc(100vh - 120px);
      }

      canvas {
        max-height: calc(100vh - 120px);
        width: auto;
        max-width: 100%;
      }

      #controls-mobile {
        max-width: 180px;
        padding: 8px;
        order: 3;
      }

      #joystick-container {
        width: 140px;
        height: 140px;
      }

      #joystick-base {
        width: 140px;
        height: 140px;
      }

      #joystick-stick {
        width: 55px;
        height: 55px;
      }

      #joystick-stick::before {
        font-size: 20px;
      }

      .joystick-direction {
        font-size: 14px;
      }

      .action-btn {
        padding: 6px 12px;
        font-size: 11px;
      }

      #message {
        font-size: 11px;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body>
  <h1>PAC-MAN MOBILE</h1>
  
  <div id="stats">
    <div class="stat">
      <span class="stat-label">SCORE</span>
      <div class="stat-value" id="score-value">0</div>
    </div>
    <div class="stat">
      <span class="stat-label">NIVEAU</span>
      <div class="stat-value" id="level-value">1</div>
    </div>
    <div class="stat">
      <span class="stat-label">RECORD</span>
      <div class="stat-value" id="high-score-value">0</div>
    </div>
    <div class="stat">
      <span class="stat-label">VIES</span>
      <div class="lives-container" id="lives-container"></div>
    </div>
  </div>

  <div id="game-layout">
    <!-- Pouvoirs √† gauche -->
    <div id="powers-info">
      <div class="power-mini">
        <span class="power-mini-icon power-invincible">‚ö°</span>
        <div class="power-mini-text">
          <span class="power-mini-name power-invincible">Invincibilit√©</span>
          <span class="power-mini-duration">8s</span>
        </div>
      </div>
      <div class="power-mini">
        <span class="power-mini-icon power-speed">üöÄ</span>
        <div class="power-mini-text">
          <span class="power-mini-name power-speed">Vitesse</span>
          <span class="power-mini-duration">6s</span>
        </div>
      </div>
      <div class="power-mini">
        <span class="power-mini-icon power-shield">üõ°Ô∏è</span>
        <div class="power-mini-text">
          <span class="power-mini-name power-shield">Bouclier</span>
          <span class="power-mini-duration">10s</span>
        </div>
      </div>
      <div class="power-mini">
        <span class="power-mini-icon power-freeze">‚ùÑÔ∏è</span>
        <div class="power-mini-text">
          <span class="power-mini-name power-freeze">Freeze</span>
          <span class="power-mini-duration">5s</span>
        </div>
      </div>
      <button class="action-btn" id="fullscreen-btn">üì± Plein √©cran</button>
    </div>

    <!-- Jeu au centre -->
    <div id="game-container">
      <div id="game">
        <canvas id="canvas" width="448" height="352"></canvas>
      </div>
      <div id="pause-overlay">‚è∏ PAUSE</div>
    </div>

    <!-- Contr√¥les √† droite -->
    <div id="controls-mobile">
      <div id="joystick-container">
        <div id="joystick-base">
          <span class="joystick-direction joystick-up">‚ñ≤</span>
          <span class="joystick-direction joystick-down">‚ñº</span>
          <span class="joystick-direction joystick-left">‚óÑ</span>
          <span class="joystick-direction joystick-right">‚ñ∫</span>
        </div>
        <div id="joystick-stick"></div>
      </div>

      <!-- Ancien dpad cach√© -->
      <div id="dpad" style="display: none;">
        <button class="dpad-btn" id="up-btn">‚ñ≤</button>
        <button class="dpad-btn" id="left-btn">‚óÑ</button>
        <button class="dpad-btn center" id="pause-btn">‚è∏</button>
        <button class="dpad-btn" id="right-btn">‚ñ∫</button>
        <button class="dpad-btn" id="down-btn">‚ñº</button>
      </div>

      <div class="action-buttons">
        <button class="action-btn" id="pause-btn-new">‚è∏</button>
        <button class="action-btn" id="restart-btn">üîÑ</button>
      </div>
      
      <div class="action-buttons">
        <button class="action-btn" id="customize-btn">üé® Perso</button>
        <button class="action-btn" id="share-btn">üì§ Partager</button>
      </div>
    </div>
  </div>

  <div id="message"></div>

  <!-- Menu de personnalisation -->
  <div id="customization-menu">
    <div class="menu-content">
      <div class="menu-header">
        <div class="menu-title">üé® Personnalisation</div>
        <button class="close-btn" id="close-menu">‚úï</button>
      </div>

      <!-- Statistiques -->
      <div class="stats-display">
        <div class="section-title">üìä Tes Statistiques</div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-box-value" id="total-score">0</div>
            <div class="stat-box-label">Score Total</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-value" id="total-games">0</div>
            <div class="stat-box-label">Parties Jou√©es</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-value" id="total-ghosts">0</div>
            <div class="stat-box-label">Fant√¥mes Mang√©s</div>
          </div>
          <div class="stat-box">
            <div class="stat-box-value" id="achievements-count">0/10</div>
            <div class="stat-box-label">Succ√®s D√©bloqu√©s</div>
          </div>
        </div>
      </div>

      <!-- Skins -->
      <div class="menu-section">
        <div class="section-title">üë§ Skins Pac-Man</div>
        <div class="skins-grid" id="skins-grid"></div>
      </div>

      <!-- Th√®mes -->
      <div class="menu-section">
        <div class="section-title">üé® Th√®mes</div>
        <div class="themes-grid" id="themes-grid"></div>
      </div>

      <!-- Succ√®s -->
      <div class="menu-section">
        <div class="section-title">üèÜ Succ√®s</div>
        <div class="achievements-list" id="achievements-list"></div>
      </div>
    </div>
  </div>

  <!-- Notification de succ√®s -->
  <div class="achievement-notification" id="achievement-notif">
    <div class="notif-icon">üèÜ</div>
    <div class="notif-text">
      <div class="notif-title" id="notif-title">Succ√®s d√©bloqu√© !</div>
      <div class="notif-desc" id="notif-desc">Description</div>
    </div>
  </div>

  <script>
    // ===== SYST√àME DE PERSONNALISATION =====
    const gameData = {
      skins: [
        { id: 'classic', icon: 'üü°', name: 'Classique', unlocked: true },
        { id: 'robot', icon: 'ü§ñ', name: 'Robot', unlocked: false, requirement: 'score500' },
        { id: 'alien', icon: 'üëΩ', name: 'Alien', unlocked: false, requirement: 'ghosts20' },
        { id: 'ninja', icon: 'ü•∑', name: 'Ninja', unlocked: false, requirement: 'level5' },
        { id: 'pirate', icon: 'üè¥‚Äç‚ò†Ô∏è', name: 'Pirate', unlocked: false, requirement: 'games10' },
        { id: 'astronaut', icon: 'üë®‚ÄçüöÄ', name: 'Astronaute', unlocked: false, requirement: 'score1000' },
        { id: 'vampire', icon: 'üßõ', name: 'Vampire', unlocked: false, requirement: 'ghosts50' },
        { id: 'wizard', icon: 'üßô', name: 'Mage', unlocked: false, requirement: 'achievements5' },
      ],
      themes: [
        { id: 'classic', name: 'Classique', colors: { bg: '#020617', wall: '#1d4ed8', dot: '#facc15' } },
        { id: 'cyberpunk', name: 'Cyberpunk', colors: { bg: '#0a0118', wall: '#ff00ff', dot: '#00ffff' } },
        { id: 'forest', name: 'For√™t', colors: { bg: '#0f2027', wall: '#2ecc71', dot: '#f39c12' } },
        { id: 'sunset', name: 'Coucher', colors: { bg: '#1a1034', wall: '#ff6b6b', dot: '#ffd93d' } },
        { id: 'ocean', name: 'Oc√©an', colors: { bg: '#001220', wall: '#0891b2', dot: '#fbbf24' } },
      ],
      achievements: [
        { id: 'first_game', icon: 'üéÆ', name: 'Premi√®re Partie', desc: 'Jouer ta premi√®re partie', progress: 0, max: 1, unlocked: false },
        { id: 'score500', icon: '‚≠ê', name: 'Score 500', desc: 'Atteindre 500 points', progress: 0, max: 500, unlocked: false },
        { id: 'score1000', icon: 'üåü', name: 'Score 1000', desc: 'Atteindre 1000 points', progress: 0, max: 1000, unlocked: false },
        { id: 'ghosts20', icon: 'üëª', name: 'Chasseur', desc: 'Manger 20 fant√¥mes', progress: 0, max: 20, unlocked: false },
        { id: 'ghosts50', icon: 'üíÄ', name: 'Exterminateur', desc: 'Manger 50 fant√¥mes', progress: 0, max: 50, unlocked: false },
        { id: 'level5', icon: 'üöÄ', name: 'Niveau 5', desc: 'Atteindre le niveau 5', progress: 0, max: 5, unlocked: false },
        { id: 'games10', icon: 'üéØ', name: 'Pers√©v√©rant', desc: 'Jouer 10 parties', progress: 0, max: 10, unlocked: false },
        { id: 'combo4', icon: 'üî•', name: 'Combo Master', desc: 'Manger 4 fant√¥mes d\'affil√©e', progress: 0, max: 1, unlocked: false },
        { id: 'speedster', icon: '‚ö°', name: 'Speedster', desc: 'Utiliser 10 power-ups vitesse', progress: 0, max: 10, unlocked: false },
        { id: 'achievements5', icon: 'üèÜ', name: 'Collectionneur', desc: 'D√©bloquer 5 succ√®s', progress: 0, max: 5, unlocked: false },
      ]
    };

    let playerStats = {
      pseudo: null,
      currentSkin: 'classic',
      currentTheme: 'classic',
      totalScore: 0,
      totalGames: 0,
      totalGhosts: 0,
      highestLevel: 1,
      speedPowerUps: 0,
    };

    // Charger les donn√©es sauvegard√©es
    function loadGameData() {
  const saved = localStorage.getItem("pacmanPlayerData");
  if (saved) {
    const data = JSON.parse(saved);
    playerStats = {
      ...playerStats,
      ...data.stats,
    };
    gameData.skins = data.skins;
    gameData.achievements = data.achievements;
  }
}

    function askPseudo() {
  let pseudo = prompt("Choisis ton pseudo :");
  if (pseudo) {
    pseudo = pseudo.trim();
    if (pseudo.length > 0) {
      playerStats.pseudo = pseudo;
      saveGameData();
    }
  }
}

loadGameData();
if (!playerStats.pseudo) {
  askPseudo();
}
applyTheme(playerStats.currentTheme);

    


    // Sauvegarder les donn√©es
    function saveGameData() {
      localStorage.setItem('pacmanPlayerData', JSON.stringify({
        stats: playerStats,
        skins: gameData.skins,
        achievements: gameData.achievements
      }));
    }

    // V√©rifier et d√©bloquer les skins
    function checkSkinUnlocks() {
      gameData.skins.forEach(skin => {
        if (skin.unlocked) return;
        
        let shouldUnlock = false;
        switch(skin.requirement) {
          case 'score500':
            shouldUnlock = playerStats.totalScore >= 500;
            break;
          case 'score1000':
            shouldUnlock = playerStats.totalScore >= 1000;
            break;
          case 'ghosts20':
            shouldUnlock = playerStats.totalGhosts >= 20;
            break;
          case 'ghosts50':
            shouldUnlock = playerStats.totalGhosts >= 50;
            break;
          case 'level5':
            shouldUnlock = playerStats.highestLevel >= 5;
            break;
          case 'games10':
            shouldUnlock = playerStats.totalGames >= 10;
            break;
          case 'achievements5':
            shouldUnlock = gameData.achievements.filter(a => a.unlocked).length >= 5;
            break;
        }
        
        if (shouldUnlock) {
          skin.unlocked = true;
          showNotification('üéâ Nouveau Skin D√©bloqu√© !', `${skin.icon} ${skin.name}`);
        }
      });
    }

    // V√©rifier et d√©bloquer les succ√®s
    function checkAchievements() {
      gameData.achievements.forEach(achievement => {
        if (achievement.unlocked) return;
        
        let newProgress = achievement.progress;
        
        switch(achievement.id) {
          case 'first_game':
            newProgress = Math.min(playerStats.totalGames, 1);
            break;
          case 'score500':
            newProgress = Math.min(playerStats.totalScore, 500);
            break;
          case 'score1000':
            newProgress = Math.min(playerStats.totalScore, 1000);
            break;
          case 'ghosts20':
            newProgress = Math.min(playerStats.totalGhosts, 20);
            break;
          case 'ghosts50':
            newProgress = Math.min(playerStats.totalGhosts, 50);
            break;
          case 'level5':
            newProgress = Math.min(playerStats.highestLevel, 5);
            break;
          case 'games10':
            newProgress = Math.min(playerStats.totalGames, 10);
            break;
          case 'speedster':
            newProgress = Math.min(playerStats.speedPowerUps, 10);
            break;
          case 'achievements5':
            newProgress = Math.min(gameData.achievements.filter(a => a.unlocked).length, 5);
            break;
        }
        
        achievement.progress = newProgress;
        
        if (newProgress >= achievement.max && !achievement.unlocked) {
          achievement.unlocked = true;
          showNotification(`üèÜ ${achievement.name}`, achievement.desc);
        }
      });
    }

    // Afficher une notification
    function showNotification(title, desc) {
      const notif = document.getElementById('achievement-notif');
      document.getElementById('notif-title').textContent = title;
      document.getElementById('notif-desc').textContent = desc;
      notif.classList.add('show');
      
      setTimeout(() => {
        notif.classList.remove('show');
      }, 4000);
    }

    // Appliquer le th√®me
    function applyTheme(themeId) {
      const theme = gameData.themes.find(t => t.id === themeId);
      if (!theme) return;
      
      playerStats.currentTheme = themeId;
      document.documentElement.style.setProperty('--theme-bg', theme.colors.bg);
      document.documentElement.style.setProperty('--theme-wall', theme.colors.wall);
      document.documentElement.style.setProperty('--theme-dot', theme.colors.dot);
      
      saveGameData();
    }

    // Mettre √† jour l'interface du menu
    function updateCustomizationMenu() {
      // Statistiques
      document.getElementById('total-score').textContent = playerStats.totalScore.toLocaleString();
      document.getElementById('total-games').textContent = playerStats.totalGames;
      document.getElementById('total-ghosts').textContent = playerStats.totalGhosts;
      const unlockedCount = gameData.achievements.filter(a => a.unlocked).length;
      document.getElementById('achievements-count').textContent = `${unlockedCount}/${gameData.achievements.length}`;
      
      // Skins
      const skinsGrid = document.getElementById('skins-grid');
      skinsGrid.innerHTML = '';
      gameData.skins.forEach(skin => {
        const div = document.createElement('div');
        div.className = `skin-item ${skin.id === playerStats.currentSkin ? 'active' : ''} ${!skin.unlocked ? 'locked' : ''}`;
        div.innerHTML = `
          ${!skin.unlocked ? '<span class="lock-icon">üîí</span>' : ''}
          <div class="skin-icon">${skin.icon}</div>
          <div class="skin-name">${skin.name}</div>
        `;
        if (skin.unlocked) {
          div.onclick = () => {
            playerStats.currentSkin = skin.id;
            saveGameData();
            updateCustomizationMenu();
          };
        }
        skinsGrid.appendChild(div);
      });
      
      // Th√®mes
      const themesGrid = document.getElementById('themes-grid');
      themesGrid.innerHTML = '';
      gameData.themes.forEach(theme => {
        const div = document.createElement('div');
        div.className = `theme-item ${theme.id === playerStats.currentTheme ? 'active' : ''}`;
        div.innerHTML = `
          <div class="theme-preview" style="background: linear-gradient(135deg, ${theme.colors.bg}, ${theme.colors.wall})"></div>
          <div class="theme-name">${theme.name}</div>
        `;
        div.onclick = () => applyTheme(theme.id);
        themesGrid.appendChild(div);
      });
      
      // Succ√®s
      const achievementsList = document.getElementById('achievements-list');
      achievementsList.innerHTML = '';
      gameData.achievements.forEach(achievement => {
        const div = document.createElement('div');
        div.className = `achievement-item ${achievement.unlocked ? 'unlocked' : ''}`;
        const progressText = achievement.unlocked ? '‚úÖ D√©bloqu√©' : `${achievement.progress}/${achievement.max}`;
        div.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-info">
            <div class="achievement-name">${achievement.name}</div>
            <div class="achievement-desc">${achievement.desc}</div>
            <div class="achievement-progress">${progressText}</div>
          </div>
        `;
        achievementsList.appendChild(div);
      });
    }

    // Partager le score
    function shareScore() {
      const text = `üéÆ J'ai marqu√© ${score} points au Pac-Man ! Niveau ${level} üèÜ\n\nBattez mon score : https://urlr.me/ebMSPR`;
      
      if (navigator.share) {
        navigator.share({
          title: 'Mon score Pac-Man',
          text: text,
        }).catch(() => {});
      } else {
        // Copier dans le presse-papier
        navigator.clipboard.writeText(text).then(() => {
          showNotification('üìã Copi√© !', 'Score copi√© dans le presse-papier');
        }).catch(() => {
          alert(text);
        });
      }
    }

    // Events du menu
    document.getElementById('customize-btn').addEventListener('click', () => {
      document.getElementById('customization-menu').classList.add('active');
      updateCustomizationMenu();
    });

    document.getElementById('close-menu').addEventListener('click', () => {
      document.getElementById('customization-menu').classList.remove('active');
    });

    document.getElementById('share-btn').addEventListener('click', shareScore);

    // Charger les donn√©es au d√©marrage
    loadGameData();
    applyTheme(playerStats.currentTheme);

    // ===== CODE DU JEU ORIGINAL =====
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const scoreEl = document.getElementById("score-value");
    const levelEl = document.getElementById("level-value");
    const highScoreEl = document.getElementById("high-score-value");
    const livesContainer = document.getElementById("lives-container");
    const messageEl = document.getElementById("message");
    const pauseOverlay = document.getElementById("pause-overlay");

    // Maps pour diff√©rents niveaux
    // 0: vide, 1: mur, 2: pastille, 3: invincibilit√©, 4: vitesse, 5: bouclier, 6: freeze
    const maps = [
      // Niveau 1
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,1,2,2,2,2,1,2,2,2,1],
        [1,3,1,2,1,2,1,1,2,1,2,1,4,1],
        [1,2,1,2,2,2,2,2,2,2,2,1,2,1],
        [1,2,1,1,1,2,1,1,1,2,1,1,2,1],
        [1,2,2,2,1,2,2,0,2,2,1,2,2,1],
        [1,2,1,2,1,1,2,2,2,1,1,2,1,1],
        [1,2,1,2,2,2,2,2,2,2,2,2,2,1],
        [1,5,1,2,1,1,2,1,1,1,2,1,6,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // Niveau 2
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,2,1,1,1,1,2,1,1,2,1],
        [1,4,1,2,2,2,2,2,2,2,2,1,3,1],
        [1,2,2,2,1,1,2,2,1,1,2,2,2,1],
        [1,2,1,2,2,2,2,0,2,2,2,2,1,1],
        [1,2,1,2,1,1,2,2,2,1,1,2,1,1],
        [1,2,2,2,2,2,2,1,2,2,2,2,2,1],
        [1,5,1,1,2,1,2,2,2,1,2,1,6,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ],
      // Niveau 3
      [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,1,2,2,1,2,2,2,2,1],
        [1,2,1,1,2,1,2,2,1,2,1,1,2,1],
        [1,2,1,3,2,2,2,2,2,2,6,1,2,1],
        [1,2,1,2,1,1,1,1,1,1,2,1,2,1],
        [1,2,2,2,2,2,2,0,2,2,2,2,2,1],
        [1,2,1,2,1,1,1,1,1,1,2,1,2,1],
        [1,2,1,4,2,2,2,2,2,2,5,1,2,1],
        [1,2,1,1,2,1,2,2,1,2,1,1,2,1],
        [1,2,2,2,2,1,2,2,1,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1]
      ]
    ];

    // Syst√®me de r√©apparition des power-ups
    const powerUpRespawn = {
      enabled: true,
      respawnTime: 15000,
      collected: new Map()
    };

    const tileSize = 32;
    let currentMap = [];
    let originalMap = [];
    let rows, cols;

    const pacman = {
      row: 5,
      col: 7,
      dir: { x: 0, y: 0 },
      nextDir: { x: 0, y: 0 },
      radius: tileSize / 2 - 4,
      mouthAngle: 0.25,
      mouthOpening: true,
      powered: false,
      powerTimer: 0,
      powerDuration: 8000,
      speed: 1,
      shield: false,
      freeze: false
    };

    const ghosts = [
      { row: 1, col: 1, color: "#ef4444", baseColor: "#ef4444", dir: { x: 1, y: 0 }, stepTimer: 0, name: "Blinky", scatterTarget: {row: 0, col: 13} },
      { row: 1, col: 12, color: "#ec4899", baseColor: "#ec4899", dir: { x: -1, y: 0 }, stepTimer: 0, name: "Pinky", scatterTarget: {row: 0, col: 0} },
      { row: 9, col: 1, color: "#06b6d4", baseColor: "#06b6d4", dir: { x: 1, y: 0 }, stepTimer: 0, name: "Inky", scatterTarget: {row: 10, col: 13} },
      { row: 9, col: 12, color: "#f97316", baseColor: "#f97316", dir: { x: -1, y: 0 }, stepTimer: 0, name: "Clyde", scatterTarget: {row: 10, col: 0} }
    ];

    let score = 0;
    let level = 1;
    let highScore = localStorage.getItem('pacmanHighScore') || 0;
    let lives = 3;
    let totalDots = 0;
    let gameOver = false;
    let paused = false;
    let combo = 0;
    let comboTimer = 0;
    let ghostsEaten = 0;

    const baseGhostDelay = 280;
    const basePacmanDelay = 120;
    let ghostStepDelay = baseGhostDelay;
    let pacmanStepDelay = basePacmanDelay;
    let pacmanStepTimer = 0;
    let lastTime = 0;

    const powerUpTypes = {
      3: { name: 'Invincibilit√©', color: '#facc15', duration: 8000, icon: '‚ö°' },
      4: { name: 'Vitesse', color: '#22c55e', duration: 6000, icon: 'üöÄ' },
      5: { name: 'Bouclier', color: '#3b82f6', duration: 10000, icon: 'üõ°Ô∏è' },
      6: { name: 'Freeze', color: '#a855f7', duration: 5000, icon: '‚ùÑÔ∏è' }
    };

    const sounds = {
      eatDot: () => addPoints(10),
      eatPowerPellet: () => {
        addPoints(50);
        canvas.style.filter = 'brightness(1.5)';
        setTimeout(() => canvas.style.filter = 'brightness(1)', 300);
      },
      eatGhost: (multiplier) => {
        addPoints(200 * multiplier);
        showComboPopup(200 * multiplier);
      },
      death: () => {
        messageEl.textContent = "üíÄ A√Øe ! Vie perdue...";
        setTimeout(() => messageEl.textContent = "", 2000);
      }
    };

    function init() {
      currentMap = JSON.parse(JSON.stringify(maps[Math.min(level - 1, maps.length - 1)]));
      originalMap = JSON.parse(JSON.stringify(currentMap));
      rows = currentMap.length;
      cols = currentMap[0].length;
      
      totalDots = 0;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          if (currentMap[r][c] === 2) totalDots++;
        }
      }
      
      scoreEl.textContent = score;
      levelEl.textContent = level;
      highScoreEl.textContent = highScore;
      updateLivesDisplay();
      messageEl.textContent = "";
      gameOver = false;
      paused = false;
      
      pacman.row = 5;
      pacman.col = 7;
      pacman.dir = { x: 0, y: 0 };
      pacman.nextDir = { x: 0, y: 0 };
      pacman.powered = false;
      pacman.powerTimer = 0;
      pacman.speed = 1;
      pacman.shield = false;
      pacman.freeze = false;
      
      ghostStepDelay = Math.max(150, baseGhostDelay - (level - 1) * 20);
      pacmanStepDelay = Math.max(80, basePacmanDelay - (level - 1) * 5);
      
      const startPositions = [
        {row: 1, col: 1}, {row: 1, col: 12}, 
        {row: 9, col: 1}, {row: 9, col: 12}
      ];
      ghosts.forEach((ghost, i) => {
        ghost.row = startPositions[i].row;
        ghost.col = startPositions[i].col;
        ghost.stepTimer = 0;
        ghost.color = ghost.baseColor;
      });
      
      pacmanStepTimer = 0;
      combo = 0;
      ghostsEaten = 0;
      powerUpRespawn.collected.clear();
    }

    function updateLivesDisplay() {
      livesContainer.innerHTML = '';
      for (let i = 0; i < lives; i++) {
        const lifeIcon = document.createElement('div');
        lifeIcon.className = 'life-icon';
        livesContainer.appendChild(lifeIcon);
      }
    }

    function addPoints(points) {
      score += points;
      scoreEl.textContent = score;
      
      if (score > highScore) {
        highScore = score;
        highScoreEl.textContent = highScore;
        localStorage.setItem('pacmanHighScore', highScore);
      }
    }

    function showComboPopup(points) {
      const popup = document.createElement('div');
      popup.className = 'combo-popup';
      popup.textContent = `+${points}!`;
      popup.style.left = (pacman.col * tileSize + tileSize / 2) + 'px';
      popup.style.top = (pacman.row * tileSize) + 'px';
      document.getElementById('game').appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    function drawMap() {
      const currentTime = Date.now();
      
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          let tile = currentMap[r][c];
          const key = `${r}-${c}`;
          
          if (tile === 0 && originalMap[r][c] >= 3 && powerUpRespawn.collected.has(key)) {
            const collectedTime = powerUpRespawn.collected.get(key);
            if (currentTime - collectedTime >= powerUpRespawn.respawnTime) {
              currentMap[r][c] = originalMap[r][c];
              tile = originalMap[r][c];
              powerUpRespawn.collected.delete(key);
            }
          }

          ctx.fillStyle = "#020617";
          ctx.fillRect(c * tileSize, r * tileSize, tileSize, tileSize);

          if (tile === 1) {
            const gradient = ctx.createLinearGradient(
              c * tileSize, r * tileSize, 
              c * tileSize + tileSize, r * tileSize + tileSize
            );
            gradient.addColorStop(0, "#1e40af");
            gradient.addColorStop(1, "#1d4ed8");
            ctx.fillStyle = gradient;
            ctx.fillRect(c * tileSize + 3, r * tileSize + 3, tileSize - 6, tileSize - 6);
            
            ctx.fillStyle = "rgba(96, 165, 250, 0.3)";
            ctx.fillRect(c * tileSize + 4, r * tileSize + 4, tileSize - 8, 3);
          } else if (tile === 2) {
            ctx.fillStyle = "#f1f5f9";
            ctx.shadowBlur = 5;
            ctx.shadowColor = "#f1f5f9";
            ctx.beginPath();
            ctx.arc(
              c * tileSize + tileSize / 2,
              r * tileSize + tileSize / 2,
              3,
              0,
              Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
          } else if (tile >= 3 && tile <= 6) {
            const powerUp = powerUpTypes[tile];
            const pulseSize = 8 + Math.sin(currentTime / 200) * 2;
            
            ctx.fillStyle = powerUp.color;
            ctx.shadowBlur = 20;
            ctx.shadowColor = powerUp.color;
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.arc(
              c * tileSize + tileSize / 2,
              r * tileSize + tileSize / 2,
              pulseSize + 4,
              0,
              Math.PI * 2
            );
            ctx.fill();
            ctx.globalAlpha = 1;
            
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.arc(
              c * tileSize + tileSize / 2,
              r * tileSize + tileSize / 2,
              pulseSize,
              0,
              Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = "#0f172a";
            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(
              powerUp.icon,
              c * tileSize + tileSize / 2,
              r * tileSize + tileSize / 2
            );
          }
        }
      }
    }

    function canMoveTo(row, col) {
      if (row < 0 || col < 0 || row >= rows || col >= cols) return false;
      return currentMap[row][col] !== 1;
    }

    function movePacman() {
      const targetRow = pacman.row + pacman.nextDir.y;
      const targetCol = pacman.col + pacman.nextDir.x;
      if (canMoveTo(targetRow, targetCol)) {
        pacman.dir = { ...pacman.nextDir };
      }

      const newRow = pacman.row + pacman.dir.y;
      const newCol = pacman.col + pacman.dir.x;

      if (canMoveTo(newRow, newCol)) {
        pacman.row = newRow;
        pacman.col = newCol;

        const tile = currentMap[newRow][newCol];
        
        if (tile === 2) {
          currentMap[newRow][newCol] = 0;
          sounds.eatDot();
          totalDots--;
          combo++;
          comboTimer = 1000;
          
          if (totalDots === 0 && !gameOver) {
            levelUp();
          }
        } else if (tile >= 3 && tile <= 6) {
          const key = `${newRow}-${newCol}`;
          powerUpRespawn.collected.set(key, Date.now());
          currentMap[newRow][newCol] = 0;
          
          const powerUp = powerUpTypes[tile];
          
          pacman.powered = false;
          pacman.speed = 1;
          pacman.shield = false;
          pacman.freeze = false;
          
          switch(tile) {
            case 3:
              pacman.powered = true;
              pacman.powerTimer = powerUp.duration;
              ghostsEaten = 0;
              ghosts.forEach(ghost => ghost.color = "#3b82f6");
              messageEl.textContent = `‚ö° ${powerUp.name} activ√©e !`;
              break;
              
            case 4:
              pacman.speed = 2;
              pacman.powerTimer = powerUp.duration;
              messageEl.textContent = `üöÄ ${powerUp.name} activ√©e !`;
              playerStats.speedPowerUps++;
              break;
              
            case 5:
              pacman.shield = true;
              pacman.powerTimer = powerUp.duration;
              messageEl.textContent = `üõ°Ô∏è ${powerUp.name} activ√© !`;
              break;
              
            case 6:
              pacman.freeze = true;
              pacman.powerTimer = powerUp.duration;
              messageEl.textContent = `‚ùÑÔ∏è Fant√¥mes gel√©s !`;
              break;
          }
          
          sounds.eatPowerPellet();
          setTimeout(() => messageEl.textContent = "", 2000);
        }
      }
    }

    function levelUp() {
      gameOver = true;
      level++;
      const bonus = level * 500;
      addPoints(bonus);
      messageEl.textContent = `üéâ Niveau ${level - 1} termin√© ! Bonus: ${bonus} points`;
      
      setTimeout(() => {
        init();
      }, 3000);
    }

    function updatePacman(delta) {
      if (paused || gameOver) return;

      const currentDelay = pacmanStepDelay / pacman.speed;
      
      pacmanStepTimer += delta;
      if (pacmanStepTimer >= currentDelay) {
        pacmanStepTimer = 0;
        movePacman();
      }

      if (pacman.mouthOpening) {
        pacman.mouthAngle += 0.02 * pacman.speed;
        if (pacman.mouthAngle >= 0.45) pacman.mouthOpening = false;
      } else {
        pacman.mouthAngle -= 0.02 * pacman.speed;
        if (pacman.mouthAngle <= 0.1) pacman.mouthOpening = true;
      }

      if (pacman.powerTimer > 0) {
        pacman.powerTimer -= delta;
        
        if (pacman.powerTimer <= 0) {
          if (pacman.powered) {
            pacman.powered = false;
            ghosts.forEach(ghost => ghost.color = ghost.baseColor);
          }
          pacman.speed = 1;
          pacman.shield = false;
          pacman.freeze = false;
        }
      }

      if (comboTimer > 0) {
        comboTimer -= delta;
        if (comboTimer <= 0) {
          combo = 0;
        }
      }
    }

    function drawPacman() {
      const centerX = pacman.col * tileSize + tileSize / 2;
      const centerY = pacman.row * tileSize + tileSize / 2;

      // R√©cup√©rer le skin actuel
      const currentSkin = gameData.skins.find(s => s.id === playerStats.currentSkin);
      const useSkinIcon = currentSkin && currentSkin.icon !== 'üü°';

      let angleStart = 0;
      let angleEnd = Math.PI * 2;

      if (pacman.dir.x === 1) {
        angleStart = pacman.mouthAngle;
        angleEnd = Math.PI * 2 - pacman.mouthAngle;
      } else if (pacman.dir.x === -1) {
        angleStart = Math.PI + pacman.mouthAngle;
        angleEnd = Math.PI - pacman.mouthAngle;
      } else if (pacman.dir.y === -1) {
        angleStart = -Math.PI / 2 + pacman.mouthAngle;
        angleEnd = Math.PI * 1.5 - pacman.mouthAngle;
      } else if (pacman.dir.y === 1) {
        angleStart = Math.PI / 2 + pacman.mouthAngle;
        angleEnd = Math.PI / 2 - pacman.mouthAngle;
      }

      if (pacman.shield) {
        ctx.strokeStyle = "#3b82f6";
        ctx.lineWidth = 3;
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#3b82f6";
        ctx.beginPath();
        ctx.arc(centerX, centerY, pacman.radius + 8, 0, Math.PI * 2);
        ctx.stroke();
        ctx.shadowBlur = 0;
      }

      if (pacman.speed > 1) {
        ctx.strokeStyle = "#22c55e";
        ctx.lineWidth = 2;
        ctx.globalAlpha = 0.5;
        for (let i = 1; i <= 3; i++) {
          ctx.beginPath();
          ctx.arc(
            centerX - pacman.dir.x * i * 8,
            centerY - pacman.dir.y * i * 8,
            pacman.radius,
            angleStart,
            angleEnd
          );
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
      }

      if (pacman.powered) {
        ctx.shadowBlur = 25;
        ctx.shadowColor = "#facc15";
      }

      // Dessiner le skin ou le cercle classique
      if (useSkinIcon) {
        // Utiliser emoji/ic√¥ne
        ctx.font = `${pacman.radius * 2}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(currentSkin.icon, centerX, centerY);
      } else {
        // Dessin classique
        ctx.fillStyle = "#facc15";
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, pacman.radius, angleStart, angleEnd, false);
        ctx.closePath();
        ctx.fill();
        
        ctx.shadowBlur = 0;

        if (pacman.dir.x !== 0 || pacman.dir.y !== 0) {
          ctx.fillStyle = "#0f172a";
          const eyeX = centerX + (pacman.dir.x * 4) + (pacman.dir.y === -1 ? 0 : 3);
          const eyeY = centerY + (pacman.dir.y * 4) + (pacman.dir.x !== 0 ? -5 : 0);
          ctx.beginPath();
          ctx.arc(eyeX, eyeY, 2, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      ctx.shadowBlur = 0;
    }

    function getChaseTarget(ghost) {
      if (ghost.name === "Blinky") {
        return { row: pacman.row, col: pacman.col };
      } else if (ghost.name === "Pinky") {
        return { 
          row: pacman.row + pacman.dir.y * 4, 
          col: pacman.col + pacman.dir.x * 4 
        };
      } else if (ghost.name === "Inky") {
        return { 
          row: pacman.row + pacman.dir.y * 2, 
          col: pacman.col + pacman.dir.x * 2 
        };
      } else {
        const dist = Math.abs(ghost.row - pacman.row) + Math.abs(ghost.col - pacman.col);
        return dist > 8 ? { row: pacman.row, col: pacman.col } : ghost.scatterTarget;
      }
    }

    function getBestDirection(ghost, target) {
      const dirs = [
        { x: 1, y: 0 },
        { x: -1, y: 0 },
        { x: 0, y: 1 },
        { x: 0, y: -1 }
      ];

      let bestDir = ghost.dir;
      let bestDist = Infinity;

      for (const dir of dirs) {
        const newRow = ghost.row + dir.y;
        const newCol = ghost.col + dir.x;
        
        if (canMoveTo(newRow, newCol)) {
          const dist = Math.abs(newRow - target.row) + Math.abs(newCol - target.col);
          if (dist < bestDist) {
            bestDist = dist;
            bestDir = dir;
          }
        }
      }

      return bestDir;
    }

    function updateGhost(ghost, delta) {
      if (paused || gameOver) return;

      if (pacman.freeze) {
        return;
      }

      ghost.stepTimer += delta;
      const delay = pacman.powered ? ghostStepDelay * 1.5 : ghostStepDelay;
      
      if (ghost.stepTimer >= delay) {
        ghost.stepTimer = 0;
        
        let target;
        if (pacman.powered) {
          target = {
            row: ghost.row - (pacman.row - ghost.row),
            col: ghost.col - (pacman.col - ghost.col)
          };
        } else {
          target = getChaseTarget(ghost);
        }

        ghost.dir = getBestDirection(ghost, target);
        
        const newRow = ghost.row + ghost.dir.y;
        const newCol = ghost.col + ghost.dir.x;

        if (canMoveTo(newRow, newCol)) {
          ghost.row = newRow;
          ghost.col = newCol;
        }
      }

      if (!gameOver && ghost.row === pacman.row && ghost.col === pacman.col) {
        if (pacman.powered) {
          ghostsEaten++;
          playerStats.totalGhosts++;
          sounds.eatGhost(ghostsEaten);
          ghost.row = 5;
          ghost.col = 7;
          ghost.color = ghost.baseColor;
          
          // V√©rifier le succ√®s combo
          if (ghostsEaten >= 4) {
            const comboAchievement = gameData.achievements.find(a => a.id === 'combo4');
            if (comboAchievement && !comboAchievement.unlocked) {
              comboAchievement.progress = 1;
              comboAchievement.unlocked = true;
              showNotification('üî• Combo Master', 'Tous les fant√¥mes mang√©s !');
            }
          }
        } else if (pacman.shield) {
          ghost.row = ghost.row - ghost.dir.y;
          ghost.col = ghost.col - ghost.dir.x;
          messageEl.textContent = "üõ°Ô∏è Bouclier activ√© !";
          setTimeout(() => messageEl.textContent = "", 1000);
        } else {
          lives--;
          updateLivesDisplay();
          
          if (lives <= 0) {
            gameOver = true;
            messageEl.textContent = "üíÄ GAME OVER ! Appuie sur üîÑ pour r√©essayer";
            
            // Mettre √† jour les statistiques
            playerStats.totalScore += score;
            playerStats.totalGames++;
            if (level > playerStats.highestLevel) {
              playerStats.highestLevel = level;
            }
            
            // V√©rifier succ√®s et skins
            checkAchievements();
            checkSkinUnlocks();
            saveGameData();
          } else {
            sounds.death();
            pacman.row = 5;
            pacman.col = 7;
            pacman.dir = { x: 0, y: 0 };
            pacman.nextDir = { x: 0, y: 0 };
            pacman.powered = false;
            pacman.speed = 1;
            pacman.shield = false;
            pacman.freeze = false;
            pacman.powerTimer = 0;
            
            const startPositions = [
              {row: 1, col: 1}, {row: 1, col: 12}, 
              {row: 9, col: 1}, {row: 9, col: 12}
            ];
            ghosts.forEach((g, i) => {
              g.row = startPositions[i].row;
              g.col = startPositions[i].col;
              g.stepTimer = 0;
              g.color = g.baseColor;
            });
          }
        }
      }
    }

    function drawGhost(ghost) {
      const x = ghost.col * tileSize + tileSize / 2;
      const y = ghost.row * tileSize + tileSize / 2;
      const r = tileSize / 2 - 4;

      if (pacman.freeze) {
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#a855f7";
        ctx.globalAlpha = 0.7;
      }

      ctx.fillStyle = ghost.color;
      if (pacman.powered && !pacman.freeze) {
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#3b82f6";
      }
      
      ctx.beginPath();
      ctx.arc(x, y - 4, r, Math.PI, 0);
      ctx.lineTo(x + r, y + r - 4);
      
      const waves = 3;
      for (let i = 0; i < waves; i++) {
        const waveX = x + r - (2 * r * (i + 1)) / (waves + 1);
        const waveY = y + r - 4 + (i % 2 === 0 ? 4 : -4);
        ctx.lineTo(waveX, waveY);
      }
      
      ctx.lineTo(x - r, y + r - 4);
      ctx.closePath();
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;

      if (pacman.freeze) {
        ctx.fillStyle = "#a855f7";
        ctx.font = "16px Arial";
        ctx.textAlign = "center";
        ctx.shadowBlur = 10;
        ctx.shadowColor = "#a855f7";
        ctx.fillText("‚ùÑÔ∏è", x, y - r - 8);
        ctx.shadowBlur = 0;
      }

      if ((!pacman.powered || pacman.powerTimer > 2000) && !pacman.freeze) {
        ctx.fillStyle = "#ffffff";
        ctx.beginPath();
        ctx.arc(x - 6, y - 6, 5, 0, Math.PI * 2);
        ctx.arc(x + 6, y - 6, 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#0f172a";
        ctx.beginPath();
        ctx.arc(x - 6, y - 6, 3, 0, Math.PI * 2);
        ctx.arc(x + 6, y - 6, 3, 0, Math.PI * 2);
        ctx.fill();
      } else {
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x - 8, y - 8);
        ctx.lineTo(x - 4, y - 4);
        ctx.moveTo(x - 4, y - 8);
        ctx.lineTo(x - 8, y - 4);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x + 4, y - 8);
        ctx.lineTo(x + 8, y - 4);
        ctx.moveTo(x + 8, y - 8);
        ctx.lineTo(x + 4, y - 4);
        ctx.stroke();
      }
    }

    function loop(timestamp) {
      const delta = timestamp - lastTime;
      lastTime = timestamp;

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      updatePacman(delta);
      ghosts.forEach(ghost => updateGhost(ghost, delta));
      drawPacman();
      ghosts.forEach(ghost => drawGhost(ghost));

      requestAnimationFrame(loop);
    }

    // Joystick virtuel
    const joystickContainer = document.getElementById('joystick-container');
    const joystickStick = document.getElementById('joystick-stick');
    const joystickBase = document.getElementById('joystick-base');
    
    let joystickActive = false;
    let joystickCenterX = 0;
    let joystickCenterY = 0;
    const maxDistance = 60; // Distance maximale du stick depuis le centre

    function initJoystick() {
      const rect = joystickBase.getBoundingClientRect();
      joystickCenterX = rect.left + rect.width / 2;
      joystickCenterY = rect.top + rect.height / 2;
    }

    function handleJoystickStart(e) {
      e.preventDefault();
      joystickActive = true;
      initJoystick();
      updateJoystick(e);
      if (gameOver) { lives = 3; init(); }
    }

    function handleJoystickMove(e) {
      if (!joystickActive) return;
      e.preventDefault();
      updateJoystick(e);
    }

    function handleJoystickEnd(e) {
      e.preventDefault();
      joystickActive = false;
      // Retour au centre avec animation
      joystickStick.style.transition = 'all 0.2s ease-out';
      joystickStick.style.transform = 'translate(-50%, -50%)';
      setTimeout(() => {
        joystickStick.style.transition = '';
      }, 200);
    }

    function updateJoystick(e) {
      const touch = e.touches ? e.touches[0] : e;
      const deltaX = touch.clientX - joystickCenterX;
      const deltaY = touch.clientY - joystickCenterY;
      
      const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
      const angle = Math.atan2(deltaY, deltaX);
      
      // Limiter la distance
      const limitedDistance = Math.min(distance, maxDistance);
      const x = Math.cos(angle) * limitedDistance;
      const y = Math.sin(angle) * limitedDistance;
      
      // D√©placer le stick
      joystickStick.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      
      // D√©terminer la direction (avec zone morte)
      if (distance > 20) {
        const degrees = angle * (180 / Math.PI);
        
        // Droite: -45¬∞ √† 45¬∞
        if (degrees >= -45 && degrees < 45) {
          pacman.nextDir = { x: 1, y: 0 };
        }
        // Bas: 45¬∞ √† 135¬∞
        else if (degrees >= 45 && degrees < 135) {
          pacman.nextDir = { x: 0, y: 1 };
        }
        // Gauche: 135¬∞ √† -135¬∞
        else if (degrees >= 135 || degrees < -135) {
          pacman.nextDir = { x: -1, y: 0 };
        }
        // Haut: -135¬∞ √† -45¬∞
        else {
          pacman.nextDir = { x: 0, y: -1 };
        }
      }
    }

    // Events tactiles pour le joystick
    joystickStick.addEventListener('touchstart', handleJoystickStart);
    joystickStick.addEventListener('touchmove', handleJoystickMove);
    joystickStick.addEventListener('touchend', handleJoystickEnd);
    
    // Events souris pour le joystick (desktop)
    joystickStick.addEventListener('mousedown', handleJoystickStart);
    document.addEventListener('mousemove', handleJoystickMove);
    document.addEventListener('mouseup', handleJoystickEnd);

    // R√©initialiser le centre du joystick lors du redimensionnement
    window.addEventListener('resize', initJoystick);
    initJoystick();

    // Boutons Pause et Restart
    const pauseBtnNew = document.getElementById('pause-btn-new');
    const restartBtn = document.getElementById('restart-btn');

    pauseBtnNew.addEventListener('click', (e) => {
      e.preventDefault();
      paused = !paused;
      pauseOverlay.classList.toggle('active', paused);
    });
    pauseBtnNew.addEventListener('touchstart', (e) => {
      e.preventDefault();
      paused = !paused;
      pauseOverlay.classList.toggle('active', paused);
    });

    restartBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      score = 0;
      level = 1;
      lives = 3;
      init();
    });
    restartBtn.addEventListener('click', (e) => {
      e.preventDefault();
      score = 0;
      level = 1;
      lives = 3;
      init();
    });

    // Bouton Plein √©cran
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    fullscreenBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggleFullscreen();
    });
    fullscreenBtn.addEventListener('touchstart', (e) => {
      e.preventDefault();
      toggleFullscreen();
    });

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log('Erreur plein √©cran:', err);
        });
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        }
      }
    }

    // Mettre √† jour le texte du bouton selon l'√©tat
    document.addEventListener('fullscreenchange', () => {
      if (document.fullscreenElement) {
        fullscreenBtn.textContent = 'üì± Quitter plein √©cran';
      } else {
        fullscreenBtn.textContent = 'üì± Plein √©cran';
      }
    });

    // Support clavier pour desktop
    document.addEventListener("keydown", (e) => {
      if (e.key === " ") {
        e.preventDefault();
        paused = !paused;
        pauseOverlay.classList.toggle('active', paused);
        return;
      }

      if (e.key === "r" || e.key === "R") {
        e.preventDefault();
        score = 0;
        level = 1;
        lives = 3;
        init();
        return;
      }

      if (gameOver && ["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) {
        lives = 3;
        init();
      }

      if (e.key === "ArrowLeft") {
        e.preventDefault();
        pacman.nextDir = { x: -1, y: 0 };
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        pacman.nextDir = { x: 1, y: 0 };
      } else if (e.key === "ArrowUp") {
        e.preventDefault();
        pacman.nextDir = { x: 0, y: -1 };
      } else if (e.key === "ArrowDown") {
        e.preventDefault();
        pacman.nextDir = { x: 0, y: 1 };
      }
    });

    // Initialisation
    highScoreEl.textContent = highScore;
    init();
    requestAnimationFrame(loop);
  </script>
</body>
</html>